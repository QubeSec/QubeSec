---
- name: Install build dependencies
  apt:
    name:
      - build-essential
      - git
      - cmake
      - ninja-build
      - libssl-dev
      - curl
      - wget
      - pkg-config
      - python3
    state: present
    update_cache: yes
  become: yes

- name: Create build directory
  file:
    path: "{{ build_dir }}"
    state: directory
    mode: '0755'

- name: Clone OpenSSL repository
  git:
    repo: "https://github.com/openssl/openssl.git"
    dest: "{{ build_dir }}/openssl"
    version: "openssl-{{ openssl_version }}"
    depth: 1

- name: Configure OpenSSL with RPATH
  shell: |
    cd {{ build_dir }}/openssl
    ./Configure \
      linux-x86_64 \
      --prefix={{ openssl_prefix }} \
      -Wl,-rpath,{{ openssl_prefix }}/lib
  environment:
    LDFLAGS: "-Wl,-rpath,{{ openssl_prefix }}/lib"

- name: Build OpenSSL
  shell: |
    cd {{ build_dir }}/openssl
    make -j{{ build_threads }}
  register: openssl_build
  changed_when: "'building' in openssl_build.stdout"

- name: Install OpenSSL
  shell: |
    cd {{ build_dir }}/openssl
    make install
  become: yes

- name: Create OpenSSL lib symlinks
  file:
    src: "{{ openssl_prefix }}/lib64"
    dest: "{{ openssl_prefix }}/lib"
    state: link
    force: yes
  become: yes
  ignore_errors: yes

- name: Clone liboqs repository
  git:
    repo: "https://github.com/open-quantum-safe/liboqs.git"
    dest: "{{ build_dir }}/liboqs"
    version: "{{ liboqs_version }}"
    depth: 1

- name: Create liboqs build directory
  file:
    path: "{{ build_dir }}/liboqs/build"
    state: directory
    mode: '0755'

- name: Configure liboqs with OpenSSL
  shell: |
    cd {{ build_dir }}/liboqs/build
    cmake \
      -G Ninja \
      -DCMAKE_PREFIX_PATH={{ openssl_prefix }} \
      -DCMAKE_INSTALL_PREFIX={{ liboqs_prefix }} \
      -DBUILD_SHARED_LIBS=ON \
      ..
  environment:
    PKG_CONFIG_PATH: "{{ openssl_prefix }}/lib/pkgconfig:{{ openssl_prefix }}/lib64/pkgconfig"

- name: Build liboqs
  shell: |
    cd {{ build_dir }}/liboqs/build
    ninja -j{{ build_threads }}
  register: liboqs_build
  changed_when: "'Building' in liboqs_build.stdout"

- name: Install liboqs
  shell: |
    cd {{ build_dir }}/liboqs/build
    ninja install
  become: yes

- name: Clone oqs-provider repository
  git:
    repo: "https://github.com/open-quantum-safe/oqs-provider.git"
    dest: "{{ build_dir }}/oqs-provider"
    version: "{{ oqs_provider_version }}"
    depth: 1

- name: Create oqs-provider build directory
  file:
    path: "{{ build_dir }}/oqs-provider/build"
    state: directory
    mode: '0755'

- name: Configure oqs-provider
  shell: |
    cd {{ build_dir }}/oqs-provider/build
    cmake \
      -G Ninja \
      -DCMAKE_PREFIX_PATH={{ openssl_prefix }};{{ liboqs_prefix }} \
      -DOPENSSL_DIR={{ openssl_prefix }} \
      -Dliboqs_DIR={{ liboqs_prefix }} \
      -DCMAKE_BUILD_TYPE=Release \
      ..
  environment:
    PKG_CONFIG_PATH: "{{ openssl_prefix }}/lib/pkgconfig:{{ openssl_prefix }}/lib64/pkgconfig:{{ liboqs_prefix }}/lib/pkgconfig"

- name: Build oqs-provider
  shell: |
    cd {{ build_dir }}/oqs-provider/build
    ninja -j{{ build_threads }}
  register: oqs_build
  changed_when: "'Building' in oqs_build.stdout"

- name: Install oqs-provider
  shell: |
    cd {{ build_dir }}/oqs-provider/build
    ninja install
  become: yes

- name: Create OpenSSL modules directory
  file:
    path: "{{ openssl_prefix }}/lib64/ossl-modules"
    state: directory
    mode: '0755'
  become: yes

- name: Copy oqsprovider module
  shell: |
    cp {{ build_dir }}/oqs-provider/build/oqsprovider.so {{ openssl_prefix }}/lib64/ossl-modules/
    chmod 755 {{ openssl_prefix }}/lib64/ossl-modules/oqsprovider.so
  become: yes

- name: Configure OpenSSL to load oqs-provider
  template:
    src: openssl.cnf.j2
    dest: "{{ openssl_prefix }}/ssl/openssl.cnf"
    mode: '0644'
    backup: yes
  become: yes

- name: Set environment variables
  lineinfile:
    path: "/etc/environment"
    line: "{{ item }}"
    state: present
    create: yes
  become: yes
  loop:
    - "PATH={{ openssl_prefix }}/bin:$PATH"
    - "LD_LIBRARY_PATH={{ openssl_prefix }}/lib:{{ liboqs_prefix }}/lib:$LD_LIBRARY_PATH"
    - "PKG_CONFIG_PATH={{ openssl_prefix }}/lib/pkgconfig:{{ liboqs_prefix }}/lib/pkgconfig:$PKG_CONFIG_PATH"
    - "DEFAULT_GROUPS={{ default_groups }}"

- name: Verify OpenSSL installation
  shell: "{{ openssl_prefix }}/bin/openssl version"
  register: openssl_version_check
  changed_when: false

- name: Verify oqs-provider availability
  shell: "{{ openssl_prefix }}/bin/openssl list -providers -verbose"
  register: providers_check
  changed_when: false
  ignore_errors: yes

- name: Display verification results
  debug:
    msg: |
      OpenSSL version: {{ openssl_version_check.stdout }}
      Providers available:
      {{ providers_check.stdout | default('Verification skipped') }}
